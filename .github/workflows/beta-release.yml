name: Beta Release

on:
  workflow_dispatch:
    inputs:
      increment:
        description: 'Increment beta number (yes/no)'
        required: false
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  beta-release:
    name: Build and Publish Beta Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check Branch
        if: github.ref != 'refs/heads/main'
        run: |
          echo "ERROR: Beta releases can only be triggered from the main branch"
          exit 1

      - name: Fetch Sources
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Generate CHANGELOG.md with git-cliff
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --unreleased -o CHANGELOG.md

      - name: Bump to Beta Version
        run: |
          chmod +x ./scripts/version.sh
          if [ "${{ github.event.inputs.increment }}" = "yes" ]; then
            BETA_VERSION=$(./scripts/version.sh bump --channel=beta)
          else
            BETA_VERSION=$(./scripts/version.sh current)
          fi
          echo "BETA_VERSION=$BETA_VERSION" >> $GITHUB_ENV
          echo "Beta version: $BETA_VERSION"

      - name: Run Tests
        run: ./gradlew test

      - name: Build Plugin
        env:
          RELEASE_BUILD: true
        run: ./gradlew buildPlugin

      - name: Publish to Beta Channel
        env:
          PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
          CERTIFICATE_CHAIN: ${{ secrets.CERTIFICATE_CHAIN }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PRIVATE_KEY_PASSWORD: ${{ secrets.PRIVATE_KEY_PASSWORD }}
        run: |
          if [ -n "$PUBLISH_TOKEN" ]; then
            echo "Publishing beta build $BETA_VERSION to beta channel"
            ./gradlew publishPlugin
          else
            echo "PUBLISH_TOKEN not set, skipping publish"
          fi

      - name: Create GitHub Pre-Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_NOTE="./build/tmp/beta_release_note.txt"
          mkdir -p "$(dirname "$RELEASE_NOTE")"
          ./gradlew getChangelog --unreleased --no-header --quiet --console=plain --output-file=$RELEASE_NOTE

          gh release create $BETA_VERSION \
            --prerelease \
            --title "Beta Release $BETA_VERSION" \
            --notes-file $RELEASE_NOTE \
            --target ${{ github.sha }}

          gh release upload $BETA_VERSION ./build/distributions/*.zip

      - name: Commit Version Bump
        if: github.event.inputs.increment == 'yes'
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add gradle.properties
          git commit -m "Bump version to $BETA_VERSION" || echo "No changes to commit"
          git push origin ${{ github.ref_name }}
